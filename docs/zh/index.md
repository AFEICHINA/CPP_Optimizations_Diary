# CPP 优化日记

在C++中优化代码是没有人能够抗拒的事情。你可以愉快地玩耍，同时假装自己为组织做了有用的事情！

在这个仓库里，我将记录一些简单的设计模式，以改进您的代码并消除**C++**中不必要的开销。

如果您是经验丰富的C++专家，则可能已经在脑海中拥有一套始终遵循的规则。

这些规则帮助您看起来像一个坏屁孩/摇滚明星/10倍工程师。

您是那种在循环之前轻松投射出[std::vector<>::reserve](reserve.md)，点头微笑，看着性能提高和团队成员的惊讶的人。

![](../img/boom.gif)

希望本仓库中的示例将帮助您达到大师的地位，并作为副作用节省不必要的CPU周期，
从而拯救地球免受全球变暖的影响。

当然，随后，地球的另一边会有人开始挖掘比特币或者用**Python**编写他/她的应用程序，这样你所有的保存电力的努力都白费了。

我开玩笑，Python开发人员，我们爱你们！

>旁白：“他没有开玩笑……”

## 规则1：先测量（使用_好的_工具）

任何关心性能的人应该做的第一件事是：

- **先测量**，然后**再提出猜想**。

我和我的同事们几乎总是错误地判断某段代码的性能低下的原因。

有时我们是正确的，但很难预先知道重构将如何改善性能。良好的分析工具在几分钟内显示出“低垂果”：最小的工作，最大的收益！

总之，10分钟的分析可以为您节省数小时的猜测和重构工作。

我的Linux中的“goto”工具是[Hotspot](https://github.com/KDAB/hotspot)和[Heaptrack](https://github.com/KDE/heaptrack)。我了解Windows也有类似的工具。

![](../img/hotspot_heaptrack.jpg)

在基准测试战争中，如果您是士兵，这就是您的步枪和手榴弹。

一旦您知道哪些代码部分值得进行优化，您可能希望使用[Google Benchmark](https://github.com/google/benchmark)来测量一个非常特定的类或函数中花费的时间。

您甚至可以在此处在线运行Google Benchmark：[quick-bench.com](http://quick-bench.com/G7B2w0xPUWgOVvuzI7unES6cU4w)。

![quick-bench](../img/quick-bench.png)

## 规则2：学习好的设计模式，使用它们作为默认值

编写良好的代码就像刷牙一样：您应该无需过多考虑即可完成。

这是一个需要训练的肌肉，随着时间的推移而变得更加强壮。但不要担心：
一旦开始，您将开始看到反复出现的模式，
这些模式令人惊讶地简单，并适用于许多不同的用例。

**剧透警告**：我最喜欢的技巧之一是_尽量减少堆分配的数量_。你不知道那有多么有帮助。

但是让我们明确一些东西：

- 您作为开发人员（软件工程师？）的**第一目标**是创建符合要求的**正确**代码。
- 第二重要的事情是使您的代码对其他人来说易于**维护和阅读**。
- 在许多情况下，您也希望使代码更快，因为[更快的代码才是更好的代码](https://craigmod.com/essays/fast_software/)。

换句话说，在做任何使代码难以阅读或难以调试的改变之前，三思而后行，
仅仅因为您相信它可能运行得更快2.5％。

## 优化示例

### “如果您再次按值传递它……”

- [默认使用const引用](prefer_references.md)。

- 移动语义（待定）。

- 返回值优化（待定）。


### std::vector<>是你最好的朋友


- [默认使用std::vector<>::reserve](reserve.md)

- [“我在大学里学习了链表，我应该使用它们吗？”不是的](no_lists.md)。

- [您不需要`std::map<>`来做到这一点](dont_need_map.md)。

- [小向量优化](small_vectors.md)


### “这只是一个字符串，会有多糟？”

- [字符串（几乎）就是向量](strings_are_vectors.md)

- [何时不必担心：小字符串优化](small_strings.md)。

- [字符串连接：`operator+`虚假的安全感](strings_concatenation.md)。

- `std::string_view`：一见钟情（待定）。

### 不要重复计算。

- [示例：2D/3D智能变换](2d_transforms.md )

- [遍历2D矩阵：不太优雅，更有效率](2d_matrix_iteration.md)。

### 奇妙的数据结构及其发现之处。

- [我尝试过`boost::container::flat_map`。您无法想象接下来会发生什么](boost_flatmap.md)。

### 案例研究

- [PCL中过滤点云的更简单，更快速的方法。](pcl_filter.md)

- [更多PCL优化：来自ROS消息的转换](pcl_fromROS.md)

- [快速回文串：条件分支的代价](palindrome.md)
